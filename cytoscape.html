<!DOCTYPE html>
<html style="height:100%;">
<head>
	<title></title>
	<style type="text/css">
		html { height:100%;}
		body {height: 100%;}
		.box{width: 40px; height: 40px; background-color: lightgray; border: 1px solid black; float: left;}
		#hanuel { width: 100%; height: 100%; }
	</style>
	<script src="cytoscape.min.js"></script>
	<script src="https://code.jquery.com/jquery.min.js"></script>

	<script type="text/javascript">
    	const val = `{'clouds': [{'Data': {'database': {'terraform-20191001195726502900000001': {'SubnetId': ['subnet-497a8822', 'subnet-bebc9af2', 'subnet-1715ba6c'], 'VpcId': 'vpc-e904c482'}, 'database-server': {'SubnetId': ['subnet-03caf6545b12099f6', 'subnet-0e3bc50b2594c84c7', 'subnet-06ebe45115cf8c76a'], 'VpcId': 'vpc-04a58794b18d7adb2'}}, 'compute': {'i-0e825a076ae3c0a45': {'SubnetId': 'subnet-03def257f73fcb38d', 'VpcId': 'vpc-096dd0497219372e8'}}}, 'Name': 'aws', 'Vendor': 'aws'}]
}`

		var instance_list = []
		var instance_dict = {}
		var subnet_dict = {}

		var instance_edges = []
		var instance_nodes = []

		var cyto = null


		$(document).ready(function(){
			draw_map()

			$("button").click(function(){
				edges = []
				nodes = []
				instance_list = []
				convert_instance_list = []
				compelete_instance = []
				sig.graph.clear()

				draw_map()
			})
		})
		var n1n2 = ''
		function make_cytoscape(){
			var style_str = "cytoscape.stylesheet()"
			style_str += `.selector('node').css({
				'height': 80,
				'width': 80,
				'background-fit': 'cover',
				'border-color': '#000',
				'border-width': 1,
				'border-opacity': 0.5,
				'label': 'data(id)',
			}).selector('.none').css({
				'width': 0,
				'height': 0
			})`

			for(var i = 1; i <= instance_list.length; i++){
				var id = "instance" + i;
				style_str +=
				".selector('#" + id +`')
					.css({
						'background-image': 'engine.png'
					})`
			}

			cyto = cytoscape({
				container: document.getElementById('hanuel'),
				boxSelectionEnabled: false,
				autounselectify: true,
				wheelSensitivity: 0.5,
				style: eval(style_str),
				elements:{
					nodes: instance_nodes,
					edges: instance_edges
				},
				layout:{
					name: 'circle',
				}
			})

			cyto.on("tap", "node", (event) => {
				n1n2 = event
				alert("Click Node!")
			})
		}


		function is_subnet_dict(subnet){
			for (var sub in subnet_dict){
				if (sub == subnet){
					return sub
				}
			}
			return false
		}


		function make_map(data){
			for (var i = 0; i < data.clouds.length; i++){
				var cloud = data.clouds[i]

				var database = cloud.Data.database
				var compute  = cloud.Data.compute

				for (var id in compute){
					instance_dict[id] = [compute[id].SubnetId]
					if (!is_subnet_dict(compute[id].SubnetId)){

						subnet_dict[compute[id].SubnetId] = compute[id].VpcId	
					}
					
					instance_list.push(id)
				}

				for (var id in database){
					instance_dict[id] = database[id].SubnetId
					for (var i = 0; i < database[id].SubnetId.length; i++){

						if (!is_subnet_dict(database[id].SubnetId[i])){
							subnet_dict[database[id].SubnetId[i]] = database[id].VpcId
						}
					}
					
					instance_list.push(id)
				}
			}
		}


		var gl = ''

		function draw_map(){
			let i;
            const data = JSON.parse(val.replace(/'/gi, '"'));
            make_map(data)
			gl = data
			

			for (var idx in instance_dict){
				if (instance_dict[idx].length == 1){
					instance_nodes.push({data: {id: idx, parent: instance_dict[idx][0]}})
				} else {
					instance_nodes.push({data: {id: idx, parent: subnet_dict[instance_dict[idx][0]]}})
					
					for (i = 0; i < instance_dict[idx].length; i++){
						instance_nodes.push({data: {parent:instance_dict[idx][i]}, classes: "none"})
						instance_edges.push({data: {source: idx, target: instance_dict[idx][i]}})	
					}		

				}
	
			}

			for (var idx in subnet_dict){
				instance_nodes.push({data: {id: idx, parent: subnet_dict[idx]}})
				instance_nodes.push({data: {id: subnet_dict[idx]}})

			}

			make_cytoscape()
		}




	</script>

</head>
<body style="height:100%;">
	<div id="hanuel" style="float: left; height: 70%; width: 90%;border: 1px solid black;"></div>		

	<div style="height: 40%; width: 100%">
		<textarea style="width:95%; height: 100%;;float: left;">



		</textarea>
		<button style="height: 100%;float: left;">Click!</button>
	</div>
</body>
</html>